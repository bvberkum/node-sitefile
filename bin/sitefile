#!/usr/bin/env coffee

_ = require 'lodash'
path = require 'path'

lib = require '../src/dotmpe/sitefile'

sitefile = lib.get_local_sitefile()

ctx = sitefile: sitefile, noderoot: path.dirname( __dirname )

express_handler = require '../src/dotmpe/sitefile/express'
app = express_handler ctx

for name in ctx.config.routers
	router_cb = require '../src/dotmpe/sitefile/routers/' + name

	router_meta = router_cb _.merge {}, ctx, sitefile
	
	handler_generator = router_meta.generate[ router_meta.default ]

	# TODO: allow access to all generators from spec
	ctx[ name ] = handler_generator

lib.apply_routes sitefile, app, ctx


ctx.server.listen ctx.port, ->
	console.log "Express server listening on port " + ctx.port

# vim:ft=coffee:
