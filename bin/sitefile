#!/usr/bin/env coffee

_ = require 'lodash'
path = require 'path'

lib = require '../src/dotmpe/sitefile'

# import the local site file
sitefile = lib.get_local_sitefile()

# prepare context and sitefile config
ctx = lib.prepare_context sitefile: sitefile, routers: {}
lib.load_config ctx

# initialize Express
express_handler = require '../src/dotmpe/sitefile/express'
app = express_handler ctx

# import handler generators
for name in ctx.config.routers
	router_cb = require '../src/dotmpe/sitefile/routers/' + name
	router_obj = router_cb _.merge {}, ctx, sitefile

	ctx.routers[name] = module: router_cb, object: router_obj
	console.log "Loaded router #{name}: #{router_obj.label}"

	# TODO: allow access to all generators from spec
	handler_generator = router_obj.generate[ router_obj.default ]
	ctx[ name ] = handler_generator

# apply Sitefile routes
lib.apply_routes sitefile, app, ctx

# server forever
ctx.server.listen ctx.port, ->
	console.log "Express server listening on port " + ctx.port

# vim:ft=coffee:
